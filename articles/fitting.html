<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting odin2 models to data • odin2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Fitting odin2 models to data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">odin2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.43</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/odin2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fitting.html">Fitting odin2 models to data</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/errors.html">Odin parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/functions.html">Supported Functions</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from odin 1.x.x</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging odin models</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/odin2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting odin2 models to data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin2/blob/main/vignettes/fitting.Rmd" class="external-link"><code>vignettes/fitting.Rmd</code></a></small>
      <div class="d-none name"><code>fitting.Rmd</code></div>
    </div>

    
    
<p>With a dynamical model we can simulate forwards in time and see how a
system might change over time, given a set of parameters. If we have a
time series data set though, we can go a step further and find
parameters consistent with the data. This vignette gives an introduction
to the approaches to fitting to data available for <code>odin2</code>
models. This support largely derives from the <a href="https://mrc-ide.github.io/monty" class="external-link"><code>monty</code></a> and <a href="https://mrc-ide.github.io/dust2" class="external-link"><code>dust2</code></a> packages
and we will refer the reader to their documentation where further detail
is on offer.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/odin2">odin2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/monty" class="external-link">monty</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="setting-the-scene">Setting the scene<a class="anchor" aria-label="anchor" href="#setting-the-scene"></a>
</h2>
<p>We’ll start with a simple data set of daily cases of some disease
over time</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"incidence.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   cases time</span></span>
<span><span class="co">#&gt; 1     3    1</span></span>
<span><span class="co">#&gt; 2     2    2</span></span>
<span><span class="co">#&gt; 3     2    3</span></span>
<span><span class="co">#&gt; 4     2    4</span></span>
<span><span class="co">#&gt; 5     1    5</span></span>
<span><span class="co">#&gt; 6     3    6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, pch <span class="op">=</span> <span class="fl">19</span>, las <span class="op">=</span> <span class="fl">1</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (days)"</span>, ylab <span class="op">=</span> <span class="st">"Cases"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="700"></p>
<p>The data here shows a classic epidemic, with cases rising up to some
peak and falling. We will try fitting this with a simple compartmental
SIR (Susceptible-Infected-Recovered) model, which we will write here in
odin2. There are a number of possible ways of writing this, but here
we’ll go for a stochastic discrete-time version, mostly because it will
allow us to demonstrate a number of features of <code>odin2</code>,
<code>dust2</code> and <code>monty</code> (and because the ODE version
is not yet written).</p>
<p>Before fitting the data, we’ll write out a model that captures the
core ideas (this is replicated from <code><a href="../articles/odin2.html">vignette("odin2")</a></code>), but
with an equation for <code>incidence</code> added (the number of new
infections over one time unit).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">incidence</span>, zero_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">incidence</span> <span class="op">+</span> <span class="va">n_SI</span></span>
<span>  <span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span></span>
<span>  <span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span></span>
<span>  <span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="op">}</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can initialise this system and simulate it out over this time
series and plot the results against the data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.3</span>, gamma <span class="op">=</span> <span class="fl">0.1</span>, I0 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_create.html" class="external-link">dust_system_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="va">pars</span>, n_particles <span class="op">=</span> <span class="fl">20</span>, dt <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_set_state_initial.html" class="external-link">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_simulate.html" class="external-link">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://mrc-ide.github.io/dust2/reference/dust_system_simulate.html" class="external-link">dust_system_simulate()</a></code> function returns an
<code>n_state</code> by <code>n_particle</code> by <code>n_time</code>
matrix (here, 4 x 20 x 101). We’re interested in incidence, and
extracting that gives us a 20 x 101 matrix, which we’ll transpose in
order to plot it:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unpack.html" class="external-link">dust_unpack_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">y</span><span class="op">)</span><span class="op">$</span><span class="va">incidence</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000055"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Time (days)"</span>, ylab <span class="op">=</span> <span class="st">"Cases"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="700"></p>
<p>The modelled trajectories are in grey, with the data points overlaid
in red – we’re not doing a great job here of capturing the data.</p>
</div>
<div class="section level2">
<h2 id="comparing-to-data">Comparing to data<a class="anchor" aria-label="anchor" href="#comparing-to-data"></a>
</h2>
<p>We’re interested in fitting this model to data, and the first thing
we need is a measure of goodness of fit, which we can also code into the
odin model, but first we’ll explain the idea.</p>
<!-- This should get more detailed coverage in dust docs, it would be good to link there once that is written -->
<p>Our system moves forward in time until it finds a new data point; at
this point in time we will have one or several particles present. We
then ask for <em>each</em> particle how likely <em>this</em> data point
is. This means that these calculations are per-particle and
per-data-point.</p>
<p>Here, we’ll use a <a href="https://en.wikipedia.org/wiki/Poisson_distribution" class="external-link">Poisson</a> to
ask “what is the probability of observing this many cases with a mean
equal to our modelled number of daily cases”.</p>
<p>The syntax for this looks a bit different to the odin code above:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">incidence</span>, zero_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">incidence</span> <span class="op">+</span> <span class="va">n_SI</span></span>
<span>  <span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span></span>
<span>  <span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span></span>
<span>  <span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span>  <span class="co"># Comparison to data</span></span>
<span>  <span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cases</span> <span class="op">~</span> <span class="fu">Poisson</span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span></span>
<span><span class="op">}</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>These last two lines are the new addition to the odin code. The first
says that <code>cases</code> will be found in the data. The second
restates our aim from the previous paragraph, comparing the observed
<code>cases</code> against modelled <code>incidence</code>. The syntax
here is designed to echo that of the <a href="https://mrc-ide.github.io/monty/articles/dsl.html" class="external-link"><code>monty</code>
DSL</a>.</p>
<p>With this version of the model we can compute likelihoods with
<code>dust2</code>’s machinery.</p>
</div>
<div class="section level2">
<h2 id="stochastic-likelihood-with-a-particle-filter">Stochastic likelihood with a particle filter<a class="anchor" aria-label="anchor" href="#stochastic-likelihood-with-a-particle-filter"></a>
</h2>
<p>Our system is <strong>stochastic</strong>; each particle will produce
a different trajectory and from that a different likelihood. Each time
we run the system we get a different combination of likelihoods. We can
use a <strong>particle filter</strong> to generate an estimate of the
marginal likelihood, averaging over this stochasticity. This works by
resampling the particles at each point along the time series, according
to how likely they are.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link">dust_filter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data</span>, n_particles <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>Each time we run this filter the likelihood will be slightly (or
very) different:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -282.4783</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -273.9318</span></span></code></pre></div>
<p>If you run the filter enough times a distribution will emerge of
course. Let’s compare two points in parameter space, varying the
<code>beta</code> parameter and running the filter 100 times each:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList</a></span><span class="op">(</span><span class="va">pars</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pars2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList</a></span><span class="op">(</span><span class="va">pars</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.23</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ll1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ll2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ll1</span>, <span class="va">ll2</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ll1</span>, <span class="va">ll2</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">ll2</span>, breaks <span class="op">=</span> <span class="va">xb</span>, col <span class="op">=</span> <span class="st">"#0000ff99"</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Log likelihood"</span>, ylab <span class="op">=</span> <span class="st">"Density"</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">ll1</span>, breaks <span class="op">=</span> <span class="va">xb</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"#ff000099"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ll1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ll2</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" alt="" width="700"></p>
<p>So even a relatively small difference in a parameter leads to a
difference in the log-likelihood that is easily detectable in only 100
runs of the filter, even when the distributions overlap. However, it
does make optimisation-based approaches to inference, such as maximum
likelihood, tricky because it’s hard to know which way “up” is if each
time you try a point it might return a different height.</p>
<p>If you run a particle filter with the argument
<code>save_trajectories = TRUE</code> then we save the trajectories of
particles over time:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.2</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                    save_trajectories <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -245.1714</span></span></code></pre></div>
<p>You can access these with
<code><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_trajectories.html" class="external-link">dust_likelihood_last_trajectories()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_trajectories.html" class="external-link">dust_likelihood_last_trajectories</a></span><span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<p>The result here is a 4 x 100 x 200 array:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   4 200 100</span></span></code></pre></div>
<p>The dimensions represent, in turn:</p>
<ol style="list-style-type: decimal">
<li>4 state variables</li>
<li>200 particles</li>
<li>100 time steps (corresponding to the data)</li>
</ol>
<p>Considering just incidence, and plotting over time, you may be able
to make out the tree structure of the trajectories, with fewer distinct
traces at the start of the time series, and some traces more heavily
represented in the final sample than others:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unpack.html" class="external-link">dust_unpack_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">h</span><span class="op">)</span><span class="op">$</span><span class="va">incidence</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="inference-with-particle-mcmc-pmcmc">Inference with particle MCMC (pMCMC)<a class="anchor" aria-label="anchor" href="#inference-with-particle-mcmc-pmcmc"></a>
</h2>
<p>We can use MCMC to explore this model, but to do this we will need a
prior. We’ll use <a href="https://mrc-ide.github.io/monty/articles/dsl.html" class="external-link">monty’s DSL</a>
to create one; this looks similar to the odin code above:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_dsl.html" class="external-link">monty_dsl</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">~</span> <span class="fu">Exponential</span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span> <span class="op">~</span> <span class="fu">Exponential</span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Here we define a prior that covers <code>beta</code> and
<code>gamma</code>, two of the three input parameters to our odin model.
This prior is a <code>monty_model</code> object, which we can use to
sample from, compute log densities with (to compute the prior), etc.</p>
<p>We also need to adapt our <code>dust2</code> filter object above for
use with <code>monty</code>. All we need to do here is to describe how a
vector of statistical parameters (here <code>beta</code> and
<code>gamma</code>) will be converted into the inputs that the
<code>sir</code> system needs to run (here a list with elements
<code>beta</code>, <code>gamma</code> and <code>I0</code>). We do this
with a <code>monty_packer</code> object:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_packer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_packer.html" class="external-link">monty_packer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"gamma"</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I0 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With this packer we can convert from a <strong>list</strong> of
name-value pairs suitable for initialising a <code>dust2</code> system
into a <strong>vector</strong> of parameters suitable for use with
<code>monty</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3 0.1</span></span></code></pre></div>
<p>and we can carry out the inverse:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_packer</span><span class="op">$</span><span class="fu">unpack</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $beta</span></span>
<span><span class="co">#&gt; [1] 0.3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gamma</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $I0</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>Combining the filter and packer we create a <code>monty</code> model,
which we’ll call <code>likelihood</code>, as that’s what it
represents:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">sir_packer</span><span class="op">)</span></span></code></pre></div>
<p>This likelihood is now also a <code>monty_model</code> object:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;monty_model&gt;</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Model has 2 parameters: 'beta' and 'gamma'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This model:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> is stochastic</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `?monty_model()` for more information</span></span></code></pre></div>
<p>The <code>monty</code> package provides a high-level interface for
working with these objects. For example, to compute the likelihood we
could now use <code><a href="https://mrc-ide.github.io/monty/reference/monty_model_density.html" class="external-link">monty_model_density()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_model_density.html" class="external-link">monty_model_density</a></span><span class="op">(</span><span class="va">likelihood</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -246.2969</span></span></code></pre></div>
<p>The difference to using <code>dust_likelihood_run</code> here is now
we provide a parameter vector from our <em>statistical model</em>,
rather than the inputs to the odin/dust model. This conforms to the
interface that <code>monty</code> uses and lets us run things like
MCMC.</p>
<p>We can combine the prior and the likelihood to create a
posterior:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="va">prior</span> <span class="op">+</span> <span class="va">likelihood</span></span></code></pre></div>
<p>The last ingredient required for running an MCMC is a sampler. We
don’t have much choice with a model where the likelihood is stochastic,
we’ll need to run a simple random walk. However, for this we still need
a proposal matrix (the variance covariance matrix that is the parameter
for a multivariate Gaussian - we’ll draw new positions from this). In an
ideal world, this distribution will have a similar shape to the target
distribution (the posterior) as this will help with mixing. To get
started, we’ll use an uncorrelated random walk with each parameter
having a fairly wide variance of 0.02</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sampler_random_walk.html" class="external-link">monty_sampler_random_walk</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.02</span><span class="op">)</span></span></code></pre></div>
<p>We can now run an MCMC for 100 samples</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sample.html" class="external-link">monty_sample</a></span><span class="op">(</span><span class="va">posterior</span>, <span class="va">sampler</span>, <span class="fl">100</span>,</span>
<span>                        initial <span class="op">=</span> <span class="va">sir_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ⡀⠀ Sampling  <span style="color: #00BB00;">■                               </span> |   1% ETA:  1s</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Sampled 100 steps across 1 chain in 402ms</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>We need to develop nice tools for working with the outputs of the
sampler, but for now bear with some grubby base R manipulation.</p>
<p>The likelihood here is very “sticky”</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-25-1.png" class="r-plt" alt="" width="700"></p>
<p>It’s hard to say a great deal about the parameters <code>beta</code>
(per-contact transmission rate) and <code>gamma</code> (recovery rate)
from this few samples, especially as we have very few <em>effective</em>
samples:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"#00000055"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-26-1.png" class="r-plt" alt="" width="700"></p>
<div class="section level3">
<h3 id="effective-sampling">Effective sampling<a class="anchor" aria-label="anchor" href="#effective-sampling"></a>
</h3>
<p>There are several things we can do here to improve how this chain
mixes</p>
<ul>
<li>We can try and find a better proposal kernel.</li>
<li>We can increase the number of particles used in the filter. This
will reduce the variance in the estimate of the marginal likelihood,
which means that the random walk will be less confused by fluctuations
in the surface it’s moving over. This comes at a computational cost
though.</li>
<li>We can increase the number of threads (effectively CPU cores) that
we are using while computing the likelihood. This will scale fairly
efficiently through to at least 10 cores, with the likelihood
calculations being almost <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel" class="external-link">embarrassingly
parallel</a>. This will help to offset some of the costs incurred
above.</li>
<li>We can run multiple chains at once. We don’t yet have a good
parallel runner implemented in <code>monty</code> but it is coming soon.
This will reduce wall time (because each chain runs at the same time)
and also allows us to compute convergence diagnostics which will reveal
how well (or badly) we are doing.</li>
<li>We can try a deterministic model (see below) to get a sense of the
general region of high probability space.</li>
</ul>
<p>Here, we apply most of these suggestions at once, using a
variance-covariance matrix <a href="https://www.youtube.com/watch?v=ziqD1xvSpF4" class="external-link">that I prepared
earlier</a>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data</span>, n_particles <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">sir_packer</span><span class="op">)</span></span>
<span><span class="va">vcv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0005</span>, <span class="fl">0.0003</span>, <span class="fl">0.0003</span>, <span class="fl">0.0003</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sampler_random_walk.html" class="external-link">monty_sampler_random_walk</a></span><span class="op">(</span><span class="va">vcv</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sample.html" class="external-link">monty_sample</a></span><span class="op">(</span><span class="va">posterior</span>, <span class="va">sampler</span>, <span class="fl">1000</span>,</span>
<span>                        initial <span class="op">=</span> <span class="va">sir_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ⡀⠀ Sampling  <span style="color: #00BB00;">■■■■■                           </span> |  14% ETA:  4s</span></span>
<span><span class="co">#&gt; ⠄⠀ Sampling  <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■■■■■■■     </span> |  86% ETA:  1s</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Sampled 1000 steps across 1 chain in 4.2s</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>The likelihood now quickly rises up to a stable range and is clearly
mixing:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">density</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-28-1.png" class="r-plt" alt="" width="700"></p>
<p>The parameters <code>beta</code> (per-contact transmission rate) and
<code>gamma</code> (recovery rate) are strongly correlated</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"#00000055"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-29-1.png" class="r-plt" alt="" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="comparing-against-vectors-of-data">Comparing against vectors of data<a class="anchor" aria-label="anchor" href="#comparing-against-vectors-of-data"></a>
</h2>
<p>Above, we were comparing against a single point of data (per
interval), but in some cases you will have vectors or higher-dimensional
objects of data. This might be the case if you were fitting to
age-disaggregated data. In this case you might write something like</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">n_age</span></span>
<span>  <span class="va">cases</span><span class="op">[</span><span class="op">]</span> <span class="op">~</span> <span class="fu">Poisson</span><span class="op">(</span><span class="va">incidence</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>where the syntax generalises our approach to handling arrays for the
rest of the odin code:</p>
<ul>
<li>
<code>cases</code> is still defined as coming as data</li>
<li>We add a <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code> equation to say that <code>cases</code>
has <code>n_age</code> elements</li>
<li>The actual comparison is now processed element-wise over all age
groups, with observed cases per age group being compared to the
corresponding modelled <code>incidence</code> value.</li>
</ul>
<p>Missing data will be handled elementwise, so this calculation is
applied to every age group that has data.</p>
<p>Passing this data into the system is a bit awkward as we no longer
have a nice time-by-datastream variable. The way we support this is by
“list columns”, which you may have seen in tidyverse packages (for
example <a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link"><code>tidyr::nest</code></a>
and <a href="https://tidyr.tidyverse.org/articles/nest.html" class="external-link">its
vignette</a>).</p>
<p>Normally, you might make a time-by-incidence <code>data.frame</code>
by writing:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, incidence <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time incidence</span></span>
<span><span class="co">#&gt; 1    1         0</span></span>
<span><span class="co">#&gt; 2    2         4</span></span>
<span><span class="co">#&gt; 3    3         6</span></span>
<span><span class="co">#&gt; 4    4        10</span></span></code></pre></div>
<p>to make a list-column for incidence we pass in a <em>list</em> with
the same number of elements as they are rows, and with the same number
of elements <em>per list element</em> as there are age groups. We then
have to wrap this with <code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code>, for example:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>           incidence <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time incidence</span></span>
<span><span class="co">#&gt; 1    1      0, 1</span></span>
<span><span class="co">#&gt; 2    2      4, 3</span></span>
<span><span class="co">#&gt; 3    3      6, 7</span></span>
<span><span class="co">#&gt; 4    4    10, 11</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="deterministic-models-from-stochastic">Deterministic models from stochastic<a class="anchor" aria-label="anchor" href="#deterministic-models-from-stochastic"></a>
</h2>
<p>Another way of fitting this model is to simply throw away the
stochasticity. In the model above we have the lines</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span></span>
<span>  <span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span></span></code></pre></div>
<p>which are the stochastic portion of the model. Each time step we
compute the number of individuals who make the transition from
<code>S</code> to <code>I</code> and from <code>I</code> to
<code>R</code> by sampling from the binomial distribution. We can
replace these calls by their expectations (so effectively making
<code>n_SI = S * p_SI</code>) by running the model in “deterministic”
mode.</p>
<p>This simplification of the stochastic model can be seen as taking
expectations of the underlying random process, but there’s no reason to
expect that this represents the mean of the whole model
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>≠</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>E</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>x</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E[f(x)] \neq f(E[x])</annotation></semantics></math>,
at least generally).</p>
<p>We have found these simplifications useful:</p>
<ul>
<li>They are not stochastic, so you can use adaptive MCMC or other more
efficient algorithms</li>
<li>They are orders of magnitude faster, because instead of running 100s
or thousands of particles per likelihood evaluation you just run
one</li>
<li>The region of high probability density of the deterministic model is
often within the (broader) region of high probability density of the
stochastic model, so you can use these models to create reasonable
starting parameter values for your chains</li>
<li>The signs and relative magnitudes of the covariances among
parameters are often similar between the deterministic and stochastic
model, so you can use the deterministic model to estimate a
variance-covariance matrix for your stochastic model – though you will
need to increase all quantities in it</li>
</ul>
<p>Obviously, this approximation comes with costs though:</p>
<ul>
<li>You no longer have integer valued quantities from the expectations
of samples in your discrete distributions, so you have to think about
fractional individuals</li>
<li>The model can no longer account for stochastic effects, e.g., at low
population sizes. This can make the model overly rigid, and it may
poorly account for observed patterns</li>
<li>The fixed <code>dt</code> approach is a <a href="https://en.wikipedia.org/wiki/Euler_method" class="external-link">first order Euler
solver</a> which offers few stability guarantees, and this will differ
from a system of ODEs solved with a better ODE solver</li>
</ul>
<p>To create a deterministic “filter” (currently, and temporarily called
an “unfilter”), use <code><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create()</a></code> in place of
<code>dust_filter_create</code>. This will replace all calls to
stochastic functions with their expectations at the point of call.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unfilter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>In contrast with <code>filter</code>, above, multiple calls to
<code>unfilter</code> with the same parameter set yield the same
result.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -543.8531</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -543.8531</span></span></code></pre></div>
<p>We can now proceed as before, reusing our <code>packer</code>,
<code>prior</code> and <code>sampler</code> objects, which are still
useable here:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood_det</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">sir_packer</span><span class="op">)</span></span>
<span><span class="va">posterior_det</span> <span class="op">&lt;-</span> <span class="va">prior</span> <span class="op">+</span> <span class="va">likelihood_det</span></span>
<span><span class="va">samples_det</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sample.html" class="external-link">monty_sample</a></span><span class="op">(</span><span class="va">posterior_det</span>, <span class="va">sampler</span>, <span class="fl">1000</span>,</span>
<span>                            initial <span class="op">=</span> <span class="va">sir_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here, you can see the 1000 samples from the deterministic model (in
blue) overlaid on top of the samples from the stochastic model (in
grey):</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"#00000033"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">samples_det</span><span class="op">$</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"#0000ff33"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-35-1.png" class="r-plt" alt="" width="700"></p>
<p>The estimated parameters here look overall shifted higher in the
deterministic model, and the correlation between the parameters
stronger. However, if we had no idea about what “good” parameters might
be, this can get us into the approximately right location.</p>
</div>
<div class="section level2">
<h2 id="differentiable-models">Differentiable models<a class="anchor" aria-label="anchor" href="#differentiable-models"></a>
</h2>
<p>We can go a step further than simply turning off stochasticity to
create a deterministic model; now that we’ve got a deterministic
likelihood function we can also differentiate that likelihood with
respect to (some of) the parameters.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu">odin2</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">incidence</span>, zero_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">incidence</span> <span class="op">+</span> <span class="va">n_SI</span></span>
<span>  <span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span></span>
<span>  <span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span></span>
<span>  <span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span>differentiate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span>differentiate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span>  <span class="co"># Comparison to data</span></span>
<span>  <span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cases</span> <span class="op">~</span> <span class="fu">Poisson</span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span></span>
<span><span class="op">}</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This the same model as above, except for the definition of
<code>beta</code> and <code>gamma</code>, which now contain the argument
<code>derivative = TRUE</code>.</p>
<p>This system can be used as a stochastic model (created via
<code>dust_filter_create</code>) just as before. The only difference is
where the model is created using
<code><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create()</a></code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unfilter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>When you run the unfilter, you can now provide the argument
<code>adjoint = TRUE</code> which will enable use of
<code><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_gradient.html" class="external-link">dust_likelihood_last_gradient()</a></code> (we may make this the
default in future).</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">pars</span>, adjoint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -543.8531</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_gradient.html" class="external-link">dust_likelihood_last_gradient</a></span><span class="op">(</span><span class="va">unfilter</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -6187.984  4780.146</span></span></code></pre></div>
<p>We can create a <code>monty</code> model with this, as before:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">sir_packer</span><span class="op">)</span></span>
<span><span class="va">likelihood</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;monty_model&gt;</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Model has 2 parameters: 'beta' and 'gamma'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This model:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> can compute gradients</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `?monty_model()` for more information</span></span></code></pre></div>
<p>and this model advertises that it can compute gradients now!</p>
<p>So from <code>monty</code> we can use
<code><a href="https://mrc-ide.github.io/monty/reference/monty_model_density.html" class="external-link">monty_model_density()</a></code> and
<code><a href="https://mrc-ide.github.io/monty/reference/monty_model_gradient.html" class="external-link">monty_model_gradient()</a></code> to compute log-likelihoods and
gradients.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_model_density.html" class="external-link">monty_model_density</a></span><span class="op">(</span><span class="va">likelihood</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -375.0398</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_model_gradient.html" class="external-link">monty_model_gradient</a></span><span class="op">(</span><span class="va">likelihood</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  5093.697 -2890.574</span></span></code></pre></div>
<p>Because the prior contained gradient information, a posterior created
with this version of the model also has gradients:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="va">prior</span></span>
<span><span class="va">posterior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;monty_model&gt;</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Model has 2 parameters: 'beta' and 'gamma'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This model:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> can compute gradients</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> can be directly sampled from</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `?monty_model()` for more information</span></span></code></pre></div>
<p>With a model configured this way, you can use the <a href="https://en.wikipedia.org/wiki/Hamiltonian_Monte_Carlo" class="external-link">Hamiltonian
Monte Carlo</a> method with <code><a href="https://mrc-ide.github.io/monty/reference/monty_sampler_hmc.html" class="external-link">monty_sampler_hmc()</a></code>, which can
be far more efficient than a random walk once tuned.</p>
<p><strong>WARNING</strong>: Using <code>derivative = TRUE</code> on
some parameters has the effect of making the rest use
<code>constant = TRUE</code>. We will describe the effects of this in a
vignette on differentiable models, soon.</p>
</div>
<div class="section level2">
<h2 id="running-multiple-parameter-sets-at-once">Running multiple parameter sets at once<a class="anchor" aria-label="anchor" href="#running-multiple-parameter-sets-at-once"></a>
</h2>
<p>You can efficiently run multiple parameter sets at once; this will be
parallelised where possible when enabled. There are two cases where this
might be useful:</p>
<ol style="list-style-type: decimal">
<li>to support things like parallel tempering where we use the same
system, the <em>same</em> data and multiple parameter sets to compute
the likelihood of multiple parameter sets simultaneously</li>
<li>to compute likelihoods across multiple “groups” in combination,
where we have the same system, <em>different</em> data and multiple
parameter sets.</li>
</ol>
<div class="section level3">
<h3 id="for-dust2-systems">For dust2 systems<a class="anchor" aria-label="anchor" href="#for-dust2-systems"></a>
</h3>
<p>When initialising the dust system, you should:</p>
<ul>
<li>pass a (typically unnamed) list of parameters, each element of which
is a different set of parameters for the system</li>
<li>pass the <code>n_groups</code> argument indicating how many groups
you wish to initialise</li>
</ul>
<p>Here is a simple case with two parameter sets that differ in
<code>beta</code>, each run with 20 particles:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.3</span>, gamma <span class="op">=</span> <span class="fl">0.1</span>, I0 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.2</span>, gamma <span class="op">=</span> <span class="fl">0.1</span>, I0 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_create.html" class="external-link">dust_system_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="va">pars2</span>, n_particles <span class="op">=</span> <span class="fl">20</span>, n_groups <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                 dt <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_set_state_initial.html" class="external-link">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_simulate.html" class="external-link">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>The dimensions of <code>y</code> is now</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   4  20   2 101</span></span></code></pre></div>
<p>representing</p>
<ul>
<li>4 state variables</li>
<li>20 particles</li>
<li>2 parameter groups</li>
<li>101 times</li>
</ul>
<p>Consider just incidence as above:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="fl">4</span>, , <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#ff000055"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Time (days)"</span>, ylab <span class="op">=</span> <span class="st">"Cases"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="fl">4</span>, , <span class="fl">2</span>, <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#0000ff55"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p><img src="fitting_files/figure-html/unnamed-chunk-44-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level3">
<h3 id="for-dust2-filtersunfilters">For dust2 filters/unfilters<a class="anchor" aria-label="anchor" href="#for-dust2-filtersunfilters"></a>
</h3>
<p>Here we assume (require, really) that each parameter set is
associated with a different data set. We may relax this in future, but
this is the typical use case we have seen. We need an additional column
called <code>group</code> in addition to <code>time</code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   group cases time</span></span>
<span><span class="co">#&gt; 1     1     3    1</span></span>
<span><span class="co">#&gt; 2     2     8    1</span></span>
<span><span class="co">#&gt; 3     1     2    2</span></span>
<span><span class="co">#&gt; 4     2     4    2</span></span>
<span><span class="co">#&gt; 5     1     2    3</span></span>
<span><span class="co">#&gt; 6     2     3    3</span></span></code></pre></div>
<p>(this is just synthetic data for now, created by duplicating and
perturbing the original data).</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data2</span>, subset <span class="op">=</span> <span class="va">group</span> <span class="op">==</span> <span class="fl">2</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (days)"</span>, ylab <span class="op">=</span> <span class="st">"Cases"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data2</span>, subset <span class="op">=</span> <span class="va">group</span> <span class="op">==</span> <span class="fl">1</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre>
<p>Because the data is grouped, we don’t need to tell
<code><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link">dust_filter_create()</a></code> that we have two groups, though you
can pass <code>n_groups = 2</code> here if you want, which will validate
that you really do have exactly two groups in the data:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link">dust_filter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data2</span>, n_particles <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>When passing parameters into the filter, you now should mirror the
format used in <code>dust_system_run()</code>; a list of lists:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter2</span>, <span class="va">pars2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -276.3184 -370.0171</span></span></code></pre></div>
<p>We now have two likelihoods returned by the filter; one per
group.</p>
<p>For the deterministic unfilter the process is the same:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unfilter2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unfilter_create.html" class="external-link">dust_unfilter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">unfilter2</span>, <span class="va">pars2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -543.8531 -609.5479</span></span></code></pre></div>
<p>however, our gradient has picked up a dimension:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_gradient.html" class="external-link">dust_likelihood_last_gradient</a></span><span class="op">(</span><span class="va">unfilter2</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]</span></span>
<span><span class="co">#&gt; [1,] -6187.984  9175.668</span></span>
<span><span class="co">#&gt; [2,]  4780.146 -6740.108</span></span></code></pre></div>
<p>Here, the first <strong>column</strong> is the gradient of the first
parameter set, and the first <strong>row</strong> is the gradient of
<code>beta</code> over parameter sets.</p>
<p>Compare with the single parameter case:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_run.html" class="external-link">dust_likelihood_run</a></span><span class="op">(</span><span class="va">unfilter</span>, <span class="va">pars2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -543.8531</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_last_gradient.html" class="external-link">dust_likelihood_last_gradient</a></span><span class="op">(</span><span class="va">unfilter</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -6187.984  4780.146</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="for-monty-models">For monty models<a class="anchor" aria-label="anchor" href="#for-monty-models"></a>
</h3>
<p>The only supported mode here is the combined likelihood case, which
requires slightly more set up. To match the monty interface, we name our
groups; we now have data for groups <code>a</code> and
<code>b</code>:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data2</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">letters</span><span class="op">[</span><span class="va">data2</span><span class="op">$</span><span class="va">group</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   group cases time</span></span>
<span><span class="co">#&gt; 1     a     3    1</span></span>
<span><span class="co">#&gt; 2     b     8    1</span></span>
<span><span class="co">#&gt; 3     a     2    2</span></span>
<span><span class="co">#&gt; 4     b     4    2</span></span>
<span><span class="co">#&gt; 5     a     2    3</span></span>
<span><span class="co">#&gt; 6     b     3    3</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link">dust_filter_create</a></span><span class="op">(</span><span class="fu">sir</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">data2</span>, n_particles <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>Here, you would use a <code>monty_packer_grouped</code> object rather
than a packer, to represent grouped structure. Here, we create a packer
for our two groups for the two parameters (<code>beta</code> and
<code>gamma</code>), indicating that <code>gamma</code> is shared
between groups and using a fixed <code>I0</code> of 5 across both
groups:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">packer2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_packer_grouped.html" class="external-link">monty_packer_grouped</a></span><span class="op">(</span>groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>                                       scalar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"gamma"</span><span class="op">)</span>,</span>
<span>                                       shared <span class="op">=</span> <span class="st">"gamma"</span>,</span>
<span>                                       fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I0 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">packer2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;monty_packer_grouped&gt;</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Packing 3 values: 'gamma', 'beta&lt;a&gt;', and 'beta&lt;b&gt;'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Packing 2 groups: 'a' and 'b'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use '$pack()' to convert from a list to a vector</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use '$unpack()' to convert from a vector to a list</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `?monty_packer_grouped()` for more information</span></span></code></pre></div>
<p>A suitable starting point for this packer might be</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">packer2</span><span class="op">$</span><span class="fu">unpack</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; $a$beta</span></span>
<span><span class="co">#&gt; [1] 0.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $a$gamma</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $a$I0</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; $b$beta</span></span>
<span><span class="co">#&gt; [1] 0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b$gamma</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b$I0</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>Now, we can build the likelihood:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">filter2</span>, <span class="va">packer2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_model_density.html" class="external-link">monty_model_density</a></span><span class="op">(</span><span class="va">likelihood2</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -611.4109</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>This vignette can only skim the surface, and is organised around
features of odin itself. The machinery for running the models comes from
<a href="https://mrc-ide.github.io/dust2" class="external-link"><code>dust2</code></a> and for
performing inference from <a href="https://mrc-ide.github.io/monty" class="external-link"><code>monty</code></a> and we
will be adding documentation to those packages that covers the details
of use.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
