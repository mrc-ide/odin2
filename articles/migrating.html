<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Migrating from odin 1.x.x • odin2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Migrating from odin 1.x.x">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">odin2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.43</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/odin2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fitting.html">Fitting odin2 models to data</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/errors.html">Odin parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/functions.html">Supported Functions</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from odin 1.x.x</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging odin models</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/odin2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Migrating from odin 1.x.x</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin2/blob/main/vignettes/migrating.Rmd" class="external-link"><code>vignettes/migrating.Rmd</code></a></small>
      <div class="d-none name"><code>migrating.Rmd</code></div>
    </div>

    
    
<p>This vignette discusses key differences with odin version 1, and with
<code>odin.dust</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/odin2">odin2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="new-features">New features<a class="anchor" aria-label="anchor" href="#new-features"></a>
</h2>
<p>Some of these features were present in versions of
<code>odin.dust</code> and many derive from underlying support in
<code>dust2</code>.</p>
<ul>
<li>Comparison to data and likelihood support (introduced in
<code>odin.dust</code>)</li>
<li>Automatic differentiation</li>
<li>More efficient setting of the subset of parameters you are likely to
use while fitting (use the <code>constant</code> argument to
<code>parameter()</code>)</li>
<li>Multiple parameter sets at once (introduced in
<code>odin.dust</code> but expanded here)</li>
<li>Run multiple copies of a system at once in parallel (introduced in
<code>odin.dust</code>)</li>
<li>Built-in support for periodic variable resetting (e.g., for
computing daily incidence)</li>
<li>Better (we hope) error messages</li>
<li>Better debugging tools (see <code><a href="../articles/debugging.html">vignette("debugging")</a></code>)</li>
<li>Compile-time bounds checking of arrays, preventing many crashes</li>
</ul>
<div class="section level3">
<h3 id="planned">Planned<a class="anchor" aria-label="anchor" href="#planned"></a>
</h3>
<ul>
<li>Optional array bounds checking, during runtime (in the latter case
with a performance penalty once enabled).</li>
</ul>
</div>
<div class="section level3">
<h3 id="hoped">Hoped<a class="anchor" aria-label="anchor" href="#hoped"></a>
</h3>
<ul>
<li>Support for multinomial samples and other vector-valued
functions</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="missing-features">Missing features<a class="anchor" aria-label="anchor" href="#missing-features"></a>
</h2>
<p>Things we do plan on implementing:</p>
<ul>
<li>Compile-time parameter substitution (<code>mrc-5575</code>)</li>
<li>Compilation to JavaScript</li>
<li>Compilation to GPU</li>
</ul>
<p>Things that we plan to drop in this version</p>
<ul>
<li>Many details in <code>config()</code> and <code>options</code>
</li>
</ul>
<p>Note that some errors are still not caught as odin errors, and
invalid odin code will be accepted and generate C++ code that fails to
compile. Please send us code that causes this to happen.</p>
</div>
<div class="section level2">
<h2 id="changes-in-syntax">Changes in syntax<a class="anchor" aria-label="anchor" href="#changes-in-syntax"></a>
</h2>
<div class="section level3">
<h3 id="user-becomes-parameter">
<code>user()</code> becomes <code>parameter()</code><a class="anchor" aria-label="anchor" href="#user-becomes-parameter"></a>
</h3>
<p>This might be the largest user-visible change, and can be
automatically migrated.</p>
<p>Previously, to support parameters you might write</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>which says that <code>a</code> is a user-supplied parameter with a
default value of <code>4</code>. In most cases this now simply
becomes</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>The <code>integer</code> argument accepted by <code>user</code> has
now changed:</p>
<ul>
<li>
<code>user(integer = TRUE)</code> becomes
<code>parameter(type = "integer")</code>
</li>
<li>
<code>user(integer = FALSE)</code> becomes
<code>parameter(type = "real")</code>
</li>
</ul>
<p>This translation can be done automatically in most cases, and will be
done (with a warning) by default if possible. You should update your
code with the suggested fix, however, as this translation will be
removed in a future version.</p>
</div>
<div class="section level3">
<h3 id="compare-keyword-is-now-removed-">Compare keyword is now removed.<a class="anchor" aria-label="anchor" href="#compare-keyword-is-now-removed-"></a>
</h3>
<p>In comparisons such as</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">compare</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fu">Normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The <code>compare</code> keyword, and the <code>~</code> only occur
together. This has been simplified, and is now written as:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">~</span> <span class="fu">Normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>which reads as: <code>d</code> is normally distributed with a mean of
0 and standard deviation of 1.</p>
</div>
<div class="section level3">
<h3 id="vector-parameters-assign-without-array-indices">Vector parameters assign without array indices<a class="anchor" aria-label="anchor" href="#vector-parameters-assign-without-array-indices"></a>
</h3>
<p>Previously, if you had a vector parameter you had to write</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">10</span></span></code></pre></div>
<p>(though with <code>user()</code>, as in the previous section).
However, the array index here does not really add anything as we already
know how many dimensions <code>a</code> has from the <code>dim</code>
call. So now you should write</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">10</span></span></code></pre></div>
<p>which makes it clearer that <strong>all</strong> of <code>a</code> is
assigned by the parameter call.</p>
</div>
<div class="section level3">
<h3 id="vectormatrixarray-parameters-whose-size-is-determined-by-input-require-rank-argument">Vector/matrix/array parameters whose size is determined by input
require <code>rank</code> argument<a class="anchor" aria-label="anchor" href="#vectormatrixarray-parameters-whose-size-is-determined-by-input-require-rank-argument"></a>
</h3>
<p>What a mouthful. Previously you might have written</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>which means “<code>a</code> is a matrix whose dimensions are
determined by the input we are given on initialisation”. Because of the
previous change the first line changes to</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>but that means that we no longer know that <code>a</code> has two
dimensions. That’s ok because we’ve moved the responsibility for this
into the <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code> assignment line anyway (internally). So for
now you write</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span>rank <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>which conveys the same intent. We may make this slightly more
friendly in future (see <code><a href="../articles/functions.html">vignette("functions")</a></code>).</p>
</div>
<div class="section level3">
<h3 id="interpolate-results-assign-without-array-indices">Interpolate results assign without array indices<a class="anchor" aria-label="anchor" href="#interpolate-results-assign-without-array-indices"></a>
</h3>
<p>Previously, if you had an <code>interpolate()</code> call that
returned a vector (or higher-dimension array) you had to write</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="st">"constant"</span><span class="op">)</span></span></code></pre></div>
<p>but now you should drop the <code>[]</code>, as for the
<code>parameter()</code> case above, as you are replacing <em>all</em>
of <code>v</code> at once, writing:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="st">"constant"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="discrete-time-models-have-a-more-solid-time-basis">Discrete-time models have a more solid time basis<a class="anchor" aria-label="anchor" href="#discrete-time-models-have-a-more-solid-time-basis"></a>
</h3>
<p>Previously, discrete time models used <code>step</code> to count
steps forward as unsigned integers, usually from zero. Many models added
a parameter (or constant) <code>dt</code> representing the timestep and
then a variable <code>time</code> which represented the time as a
real-valued number. For example you might have <code>dt</code> of 0.25
and then your model stops at times <code>[0, 0.25, 0.5, 0.75, 1]</code>
for steps <code>[0, 1, 2, 3, 4]</code>.</p>
<p>We formalise this approach now having discrete time systems be
explicitly in terms of the same time basis as ODE models (that is, some
real valued time axis). When you initialise a model you pass in
<code>dt</code>, which must be an even divisor of 1 (so 0.5, 0.25, 0.2,
etc). We then take steps of this size. The wrinkle is that (at least for
now) the model will only return control back to you, or state back to
you, at integer-valued times. We may relax this in future to allow
returning at any time value that is a multiple of <code>dt</code>.</p>
<p>This will cause a few issues for using old code, which we cover
below.</p>
<div class="section level4">
<h4 id="assignments-to-dt">Assignments to <code>dt</code><a class="anchor" aria-label="anchor" href="#assignments-to-dt"></a>
</h4>
<p>You may have models that assign to <code>dt</code>, either directly
or as a parameter. You can no longer do this as <code>dt</code> will be
provided by <code>dust</code> (see
<code><a href="https://mrc-ide.github.io/dust2/reference/dust_system_create.html" class="external-link">dust2::dust_system_create()</a></code>).</p>
<p>We can automatically remove these (with a warning) in some cases.</p>
</div>
<div class="section level4">
<h4 id="assignments-to-time">Assignments to <code>time</code><a class="anchor" aria-label="anchor" href="#assignments-to-time"></a>
</h4>
<p>Conventionally, many models would write</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">step</span> <span class="op">*</span> <span class="va">dt</span></span></code></pre></div>
<p>which is the linear transformation of time that dust2 now does. We
can remove these statements and your model should work as intended.</p>
</div>
<div class="section level4">
<h4 id="use-of-step">Use of <code>step</code><a class="anchor" aria-label="anchor" href="#use-of-step"></a>
</h4>
<p>All other uses of <code>step</code> are problematic and will need
manual fixing. We will try and accumulate migration strategies here, so
please let us know if you have had to do anything not listed.</p>
<p><strong>Access “interpolated” values from a grid</strong>: In
<code>sircovid</code> we used <code>step</code> as an array index, in
order to support time-varying inputs (e.g., vaccine allocation
schedules, rates of contact). This is no longer supported (at all)
because <code>dt</code> is changed separately from the inputs. Instead
you should use odin’s interpolation functions.</p>
<p><strong>Periodic resetting</strong>: You may have written:</p>
<pre><code><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">step</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">freq</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">b</span> <span class="kw">else</span> <span class="va">c</span></span></code></pre>
<p>to have some quantity that took different values every
<code>freq</code> steps, where <code>freq</code> is usually
<code>1/dt</code> or <code>m/dt</code> where <code>m</code> is an
integer. You should rewrite this to use <code>time</code>:</p>
<pre><code><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">time</span> <span class="op">*</span> <span class="va">dt</span> <span class="op">/</span> <span class="va">m</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">b</span> <span class="kw">else</span> <span class="va">c</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="the-name-of-the-time-variable-in-continuous-time-models-has-changed">The name of the time variable in continuous time models has
changed<a class="anchor" aria-label="anchor" href="#the-name-of-the-time-variable-in-continuous-time-models-has-changed"></a>
</h3>
<p>Previously, time was <code>t</code> but we have moved this to
<code>time</code> to be a little more explicit. We can automatically
migrate your code in many cases, unless you have defined a variable
<code>time</code> already.</p>
</div>
<div class="section level3">
<h3 id="random-number-function-calls-have-changed">Random number function calls have changed<a class="anchor" aria-label="anchor" href="#random-number-function-calls-have-changed"></a>
</h3>
<p>Previously we used the same names as R’s random-number-drawing
functions, for example <code>rbinom</code> for drawing from a binomial
distribution. This has changed to use the distribution name instead.</p>
<p>The motivating reason for this change was that in odin we might
write</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">size</span>, <span class="va">prob</span><span class="op">)</span></span></code></pre></div>
<p>but if you were writing this in R you would write</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">size</span>, <span class="va">prob</span><span class="op">)</span></span></code></pre>
<p>with the first argument being the number of draws from the
distribution in question. This departure in arguments feels needlessly
confusing! If you were using <code>odin</code> without
<code>odin.dust</code> then this did compile to a call to one of R’s
underlying random number functions so this connection was reasonable but
from version 2 we use monty’s parallelisable random number
distributions.</p>
<p>The mapping is:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta()</a></code> to <code>Beta</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom()</a></code> to <code>Binomial</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Cauchy.html" class="external-link">rcauchy()</a></code> to <code>Cauchy</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Chisquare.html" class="external-link">rchisq()</a></code> to <code>ChiSquared</code> (unsupported for
now)</li>
<li>
<code><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp()</a></code> to <code>Exponential</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">rf()</a></code> to <code>F</code> (unsupported for now)</li>
<li>
<code><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma()</a></code> to <code>Gamma</code>
</li>
<li>
<code>rgeometric()</code> to <code>Geometric</code> (unsupported for
now)</li>
<li>
<code><a href="https://rdrr.io/r/stats/Hypergeometric.html" class="external-link">rhyper()</a></code> to <code>Hypergeometric</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">rlogis()</a></code> to <code>Logistic</code> (unsupported for
now)</li>
<li>
<code><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm()</a></code> to <code>LogNormal</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom()</a></code> to <code>NegativeBinomial</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm()</a></code> to <code>Normal</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois()</a></code> to <code>Poisson</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">rt()</a></code> to <code>T</code> (unsupported for now)</li>
<li>
<code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code> to <code>Uniform</code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">rweibull()</a></code> to <code>Weibull</code>
</li>
</ul>
<p>(Not all of these are implemented yet).</p>
</div>
<div class="section level3">
<h3 id="system-size-cannot-be-changed-after-creation">System size cannot be changed after creation<a class="anchor" aria-label="anchor" href="#system-size-cannot-be-changed-after-creation"></a>
</h3>
<p>This limitation comes from our implementation in <code>dust2</code>
and it is possible to relax it in some settings. However, it is fairly
important for efficiently running the system within a pMCMC context
where we save state periodically.</p>
<p>If your system has a parameter that affects the number of state
variables in the system (e.g., the number of age categories that a
compartment is stratified by), you may not change this after
initialisation. This will be prevented by the parser once arrays are
implemented.</p>
</div>
<div class="section level3">
<h3 id="changes-in-the-way-arrays-are-handled">Changes in the way arrays are handled<a class="anchor" aria-label="anchor" href="#changes-in-the-way-arrays-are-handled"></a>
</h3>
<p>The two-argument form of <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code> has been removed, as we
did not believe it was used and it is confusingly different to R.
Previously you could write <code>dim(x, 3)</code> to get the length of
the third dimension of <code>x</code>; this is no longer supported.
Please let us know if this is a problem.</p>
</div>
</div>
<div class="section level2">
<h2 id="changes-to-how-delays-are-supported">Changes to how delays are supported<a class="anchor" aria-label="anchor" href="#changes-to-how-delays-are-supported"></a>
</h2>
<p>We support, to a degree, delay differential equations. That they work
at all is a minor miracle, especially given that the solver we use (in
dust2) is extremely simple.</p>
<div class="section level3">
<h3 id="delay-cannot-be-used-in-discrete-time-models">
<code>delay()</code> cannot be used in discrete time models<a class="anchor" aria-label="anchor" href="#delay-cannot-be-used-in-discrete-time-models"></a>
</h3>
<p>This was removed in <code>odin.dust</code> and the limitation
remains, at least for now. We may enable this later if required, please
let us know. The reason for this change is that the way that delays are
handled in continuous time is fundamentally different to how we would do
this in discrete time (particularly with stochastic expressions), but we
do not have a good motivating reason to develop this.</p>
</div>
<div class="section level3">
<h3 id="delay-results-assign-without-array-indices">
<code>delay()</code> results assign without array indices<a class="anchor" aria-label="anchor" href="#delay-results-assign-without-array-indices"></a>
</h3>
<p>Previously, if you had a <code>delay()</code> call that returned a
vector (or higher-dimension array) you had to write</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">delay</span><span class="op">(</span><span class="va">a</span>, <span class="va">tau</span><span class="op">)</span></span></code></pre></div>
<p>but now you should drop the <code>[]</code>, as for the
<code>parameter()</code> and <code>interpolate()</code> cases above, as
you are replacing <em>all</em> of <code>v</code> at once, writing:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">delay</span><span class="op">(</span><span class="va">a</span>, <span class="va">tau</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-first-argument-to-delay-must-be-the-name-of-an-equation">The first argument to <code>delay()</code> must be the name of an
equation<a class="anchor" aria-label="anchor" href="#the-first-argument-to-delay-must-be-the-name-of-an-equation"></a>
</h3>
<p>Previously, you could delay an expression (e.g.,
<code>x &lt;- delay(a + b, 1)</code>). For simplicity in implementation
we have dropped this and require that the first argument is a symbol. We
might change this later, but in the current version it makes the syntax
around handling delayed arrays a little more consistent (see above).</p>
</div>
<div class="section level3">
<h3 id="the-default-argument-to-delay-has-been-removed">The ‘default’ argument to <code>delay()</code> has been removed<a class="anchor" aria-label="anchor" href="#the-default-argument-to-delay-has-been-removed"></a>
</h3>
<p>Previously, you could write</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">delay</span><span class="op">(</span><span class="va">y</span>, <span class="va">tau</span>, <span class="va">default</span><span class="op">)</span></span></code></pre></div>
<p>to provide a default argument to the delayed value before
<code>tau</code> time had elapsed. This was not widely advertised or
used, and has been removed.</p>
</div>
<div class="section level3">
<h3 id="the-delay-time-must-be-constant">The delay time must be constant<a class="anchor" aria-label="anchor" href="#the-delay-time-must-be-constant"></a>
</h3>
<p>We require that the delay time is known at first model initialisation
and not updated subsequently (i.e., that it is numeric, a literal value
assigned to symbol or a parameter with
<code>constant = TRUE</code>).</p>
</div>
</div>
<div class="section level2">
<h2 id="general-changes">General changes<a class="anchor" aria-label="anchor" href="#general-changes"></a>
</h2>
<p>This package replaces <code>odin.dust</code> and will eventually
replace <code>odin</code> (as in, we’ll copy the entire
<code>odin2</code> code into <code>odin</code> to become version 2.0.0
of that package).</p>
<p>The relationship between packages has changed. Previously
<code>mcstate</code> “knew” about <code>dust</code> models and so you
had to use <code>odin.dust</code> practically to use the statistical
machinery in <code>mcstate</code>. We’ve changed this around now, so
that <code>odin2</code> “knows” about <code>monty</code> and can create
systems that will work well with <code>monty</code>. We now depend on
<code>monty</code>, so if you have <code>odin2</code> installed you can
start working towards fitting models immediately.</p>
</div>
<div class="section level2">
<h2 id="known-limitations">Known limitations<a class="anchor" aria-label="anchor" href="#known-limitations"></a>
</h2>
<div class="section level3">
<h3 id="much-slower-compilation-time">Much slower compilation time<a class="anchor" aria-label="anchor" href="#much-slower-compilation-time"></a>
</h3>
<p>Because we now compile to C++ via <code>dust2</code>, the compilation
times have massively increased. Previously, compilation of a simple
model took less than a second, but now this will take 6 seconds or so.
You can alleviate this to a degree during development by specifying
<code>debug = TRUE</code> when compiling, which reduces this down to
about 3 seconds. These times are from my workstation but I expect the
relative differences to hold (we’re probably 10x slower than previously
but can be “only” 5x slower if you turn off optimisation). If you were
previously using <code>odin.dust</code> you should notice little change
here.</p>
</div>
<div class="section level3">
<h3 id="loss-of-features-from-odin-1-x">Loss of features from odin 1.x<a class="anchor" aria-label="anchor" href="#loss-of-features-from-odin-1-x"></a>
</h3>
<p>Some original odin 1.x features have been lost:</p>
<p>For discrete-time systems:</p>
<ul>
<li>
<strong>You may not use <code>output()</code></strong>; see below
for workarounds and the reasons for this change.</li>
<li>
<strong>Delays are not supported</strong>; they never worked well,
particularly for stochastic systems.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="updating-old-code">Updating old code<a class="anchor" aria-label="anchor" href="#updating-old-code"></a>
</h2>
<p>If you compile odin code that contains any of the changes above, it
will try and update the code to the new version and keep going:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">odin2</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html" class="external-link">deriv</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">a</span> <span class="op">/</span> <span class="va">t</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in odin2::odin({: Found 2 compatibility issues</span></span>
<span><span class="co">#&gt; Replace calls to 'user()' with 'parameter()'</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> a &lt;- user(2)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> a &lt;- parameter(2)</span></span>
<span><span class="co">#&gt; Use 'time' and not 't' to refer to time</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> deriv(x) &lt;- x + a/t</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> deriv(x) &lt;- x + a/time</span></span></code></pre></div>
<p>This model contains two issues that can be easily rewritten; the
solution to this rewriting is printed to screen and the model is
compiled as if you had rewritten them.</p>
<p>Not everything can be rewritten, especially changes involving
<code>step</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">odin2</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">a</span> <span class="op">/</span> <span class="va">step</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `odin2::odin()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Use of 'step' is no longer allowed</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Previously, discrete-time models used 'step' as a measure of time, but we</span></span>
<span><span class="co">#&gt;   have removed this in odin2</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please see `vignette(odin2::migrating)` for guidance</span></span>
<span><span class="co">#&gt; → Context:</span></span>
<span><span class="co">#&gt; update(x) &lt;- x + a/step</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> For more information, run `odin2::odin_error_explain("E1050")`</span></span></code></pre></div>
<p>In this case, odin errors and tries to indicate where you have work
to do (and directs you to this document!)</p>
<p>For code saved into a file, you can use <code>odin_migrate</code> to
migrate code from the old syntax to the new; this will preserve comments
and formatting except for code that is rewritten so it should be fairly
unintrusive.</p>
<p>For example, in <code>path</code> (a temporary file for this
vignette) we have saved the code from above:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/deriv.html" class="external-link">deriv</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">a</span> <span class="op">/</span> <span class="va">t</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>We can migrate this in-place with:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/odin_migrate.html">odin_migrate</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Migrating 2 statements</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote '/tmp/Rtmp6A8Pzd/file1f2973a6c66b.R'</span></span></code></pre></div>
<p>and now the code contains:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/deriv.html" class="external-link">deriv</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">a</span><span class="op">/</span><span class="va">time</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="avoiding-output-in-discrete-time-systems">Avoiding <code>output()</code> in discrete-time systems<a class="anchor" aria-label="anchor" href="#avoiding-output-in-discrete-time-systems"></a>
</h3>
<p>If you have odin 1.x code, you may have a system that uses
<code>output()</code> in discrete-time; this will fail to compile.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="fu">output</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `odin()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't use 'output()' in discrete time systems</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> You should be able to do what you need using 'update()'. If you are migrating</span></span>
<span><span class="co">#&gt;   from odin 1.x.x, you might find some advice in `vignette(odin2::migrating)`</span></span>
<span><span class="co">#&gt; → Context:</span></span>
<span><span class="co">#&gt; output(y) &lt;- x/2</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> For more information, run `odin2::odin_error_explain("E2020")`</span></span></code></pre></div>
<p>Previously, this would have worked to create a system where you have
one input variable (on which the system depends) and one output variable
(entirely derived from the inputs), producing output like</p>
<pre><code><span><span class="co">#&gt;      step x   y</span></span>
<span><span class="co">#&gt; [1,]    0 1 0.5</span></span>
<span><span class="co">#&gt; [2,]    1 2 1.0</span></span>
<span><span class="co">#&gt; [3,]    2 3 1.5</span></span>
<span><span class="co">#&gt; [4,]    3 4 2.0</span></span>
<span><span class="co">#&gt; [5,]    4 5 2.5</span></span>
<span><span class="co">#&gt; [6,]    5 6 3.0</span></span></code></pre>
<p>(this comes from <a href="https://mrc-ide.github.io/odin.dust/articles/porting.html#avoiding-output" class="external-link">the
<code>odin.dust</code> migration guide</a>)</p>
<p>This is important in ODE models because there are often things that
you want to observe that are functions of the system but for which you
can’t write out equations to describe them in terms of their rates — the
sum over a set of variables for example.</p>
<p>Note here how the <code>x</code> used in the calculation is really
the <code>x</code> at the <em>end</em> of a time step, not the
<code>x</code> on inputs, which means that the output column satisfies
<code>y == x / 2</code>. This turns out to be very hard to get right and
reason about, and involved some fairly unpleasant bookkeeping in
<code>dde</code> (the package that we used to drive these systems); in
effect we run an additional time step at the end of the run in order to
compute these <code>output</code> variables, and that is inefficient for
<code>dust</code>’s use within a particle filter, and poorly behaved
with anything that used random numbers.</p>
<p>Additionally, there is no great need for <code>output</code> for
discrete time models, as we can treat <code>y</code> above as just
another variable. This also allows us to be more explicit about when
within the time step this output is being computed:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">new_x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">new_x</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">y2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">new_x</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We can run this:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_create.html" class="external-link">dust_system_create</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_set_state_initial.html" class="external-link">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_simulate.html" class="external-link">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_unpack.html" class="external-link">dust_unpack_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $y1</span></span>
<span><span class="co">#&gt; [1] 0.0 0.5 1.0 1.5 2.0 2.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $y2</span></span>
<span><span class="co">#&gt; [1] 0.0 1.0 1.5 2.0 2.5 3.0</span></span></code></pre></div>
<p>Here, the variable <code>x</code> is updated as for the original
output. The variable <code>y1</code> column computes the relationship
with the <code>x</code> at the beginning of the time step, while
<code>y2</code> is most equivalent to our previous <code>output</code>
command and requires storing the value that will become the updated
<code>x</code> in order to use that value to both update <code>x</code>
and <code>y2</code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
