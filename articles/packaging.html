<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Packaging odin models • odin2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Packaging odin models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">odin2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.38</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/odin2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fitting.html">Fitting odin2 models to data</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/errors.html">Odin parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/functions.html">Supported Functions</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from odin 1.x.x</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging odin models</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/odin2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Packaging odin models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin2/blob/main/vignettes/packaging.Rmd" class="external-link"><code>vignettes/packaging.Rmd</code></a></small>
      <div class="d-none name"><code>packaging.Rmd</code></div>
    </div>

    
    
<!-- this is duplicated from the dust vignette -->
<p>You should not use <code><a href="../reference/odin.html">odin()</a></code> within a package, because that
would cause the model to compile each time you use it, rather than when
the package builds. It may also cause issues when trying to use the
model in parallel (e.g., with the <code>parallel</code> package), and
will require all users of your code to have a full C++ toolchain.
Instead you should use <code><a href="../reference/odin_package.html">odin_package()</a></code> which will generate
appropriate code for you.</p>
<p>This vignette is based heavily on the packaging vignette in
<code>dust2</code>
(<code>vignette("packaging", package = "dust")</code>), as odin uses
<code>dust2</code>’s machinery for packaging.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/odin2">odin2</a></span><span class="op">)</span></span></code></pre></div>
<p>To package odin code, put your odin files in <code>inst/odin/</code>
within a package and run <code><a href="../reference/odin_package.html">odin_package()</a></code> on the package’s
root directory. You can have several odin systems within a single
package.</p>
<p>A skeleton package might contain:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt;     └── <span style="color: #0000BB; font-weight: bold;">odin</span></span></span>
<span><span class="co">#&gt;         └── <span style="color: #00BB00;">sir.R</span></span></span></code></pre>
<p>This is the normal R package skeleton, though missing <code>R/</code>
and <code>src/</code> directories (for now). The
<code>DESCRIPTION</code> file contains</p>
<pre class="plain"><code>Package: example
Title: Example Odin in a Package
Version: 0.0.1
Imports: dust2
LinkingTo: cpp11, dust2, monty
Authors@R: c(person('A', 'Person', role = c('aut', 'cre'),
                     email = 'person@example.com'))
License: CC0</code></pre>
<p>The important things here are:</p>
<ul>
<li>the package name (<code>Package</code>). We’re using
<code>example</code>, and names with a dot may not work as expected</li>
<li>including <a href="https://github.com/r-lib/cpp11" class="external-link"><code>cpp11</code></a>,
<code>dust2</code> and <code>monty</code> in <code>LinkingTo</code>,
which allows package compilation to find their respective header
files</li>
</ul>
<p>Our <code>NAMESPACE</code> file contains:</p>
<pre class="plain"><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="st">'example'</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
<p>This <code>useDynLib</code> call to your package in the
<code>NAMESPACE</code> file is required for R to load the compiled code
into the package.</p>
<p>The file in <code>inst/odin</code> is the odin code from
<code><a href="../articles/odin2.html">vignette("odin2")</a></code>, with <code>sir.R</code> containing</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span></span>
<span><span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu">Binomial</span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span></span>
<span></span>
<span><span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I0</span></span>
<span><span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I0</span></span>
<span><span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu">parameter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>There can be as many of these files as you want within the directory
<code>inst/odin</code>.</p>
<p>To prepare the package, run <code><a href="../reference/odin_package.html">odin_package()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/odin_package.html">odin_package</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Found 1 odin code file in 'inst/odin'</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'inst/dust/sir.cpp'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Working in package 'example' at '/tmp/RtmpZnta8Y/file2207192dba8d'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Found 1 system</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'src/sir.cpp'</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'R/dust.R'</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'src/Makevars'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 12 functions decorated with [[cpp11::register]]</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.R</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.cpp</span></span></span></code></pre></div>
<p>The directory structure now has more files:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">R</span></span></span>
<span><span class="co">#&gt; │   ├── <span style="color: #00BB00;">cpp11.R</span></span></span>
<span><span class="co">#&gt; │   └── <span style="color: #00BB00;">dust.R</span></span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt; │   ├── <span style="color: #0000BB; font-weight: bold;">dust</span></span></span>
<span><span class="co">#&gt; │   │   └── sir.cpp</span></span>
<span><span class="co">#&gt; │   └── <span style="color: #0000BB; font-weight: bold;">odin</span></span></span>
<span><span class="co">#&gt; │       └── <span style="color: #00BB00;">sir.R</span></span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">#&gt;     ├── Makevars</span></span>
<span><span class="co">#&gt;     ├── cpp11.cpp</span></span>
<span><span class="co">#&gt;     └── sir.cpp</span></span></code></pre>
<p>None of these files should be edited:</p>
<ul>
<li>
<code>inst/dust/sir.cpp</code> contains the C++ code generated by
odin, used by <code>dust2</code>
</li>
<li>
<code>src/sir.cpp</code> is the full code generated in turn by
dust</li>
<li>
<code>src/dust.R</code> contains the R definitions of the dust
system</li>
<li>
<code>src/cpp11.cpp</code> and <code>R/cpp11.R</code> are files
generated by <code>cpp11</code>
</li>
</ul>
<p>Your package can include as much R code as you want, and can be
developed like any other R package. But any time you change the code in
<code>inst/odin</code> you should rerun <code><a href="../reference/odin_package.html">odin_package()</a></code>.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
